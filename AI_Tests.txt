import pytest
from unittest.mock import patch, MagicMock
from datetime import datetime, timedelta
import library_service as lib  # correct module

# ===== R1: add_book_to_catalog =====

@patch('library_service.get_book_by_isbn')
@patch('library_service.insert_book')
def test_add_book_success(mock_insert, mock_get_isbn):
    mock_get_isbn.return_value = None
    mock_insert.return_value = True
    success, msg = lib.add_book_to_catalog("Test Title", "Author Name", "1234567890123", 3)
    assert success is True
    assert "successfully added" in msg

def test_add_book_empty_title():
    success, msg = lib.add_book_to_catalog("", "Author", "1234567890123", 1)
    assert success is False
    assert msg == "Title is required."

def test_add_book_long_title():
    long_title = "T" * 201
    success, msg = lib.add_book_to_catalog(long_title, "Author", "1234567890123", 1)
    assert success is False
    assert msg == "Title must be less than 200 characters."

def test_add_book_empty_author():
    success, msg = lib.add_book_to_catalog("Title", "", "1234567890123", 1)
    assert success is False
    assert msg == "Author is required."

def test_add_book_long_author():
    long_author = "A" * 101
    success, msg = lib.add_book_to_catalog("Title", long_author, "1234567890123", 1)
    assert success is False
    assert msg == "Author must be less than 100 characters."

def test_add_book_invalid_isbn_length():
    success, msg = lib.add_book_to_catalog("Title", "Author", "123", 1)
    assert success is False
    assert msg == "ISBN must be exactly 13 digits."

def test_add_book_invalid_isbn_non_digit():
    success, msg = lib.add_book_to_catalog("Title", "Author", "1234567890ABC", 1)
    assert success is False
    assert msg == "ISBN must be exactly 13 digits."

def test_add_book_zero_copies():
    success, msg = lib.add_book_to_catalog("Title", "Author", "1234567890123", 0)
    assert success is False
    assert msg == "Total copies must be a positive integer."

def test_add_book_non_integer_copies():
    success, msg = lib.add_book_to_catalog("Title", "Author", "1234567890123", "2")
    assert success is False
    assert msg == "Total copies must be a positive integer."

@patch('library_service.get_book_by_isbn')
def test_add_book_existing_isbn(mock_get_isbn):
    mock_get_isbn.return_value = {"title": "Existing", "isbn": "1234567890123"}
    success, msg = lib.add_book_to_catalog("Title", "Author", "1234567890123", 1)
    assert not success
    assert "already exists" in msg.lower()

@patch('library_service.get_book_by_isbn')
@patch('library_service.insert_book')
def test_add_book_db_failure(mock_insert, mock_get_isbn):
    mock_get_isbn.return_value = None
    mock_insert.return_value = False
    success, msg = lib.add_book_to_catalog("Title", "Author", "1234567890123", 1)
    assert not success
    assert "database error" in msg.lower()


# ===== R3: borrow_book_by_patron =====

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrow_count')
@patch('library_service.insert_borrow_record')
@patch('library_service.update_book_availability')
def test_borrow_book_success(mock_update_avail, mock_insert_borrow, mock_get_borrow_count, mock_get_book):
    mock_get_book.return_value = {"title": "Book Title", "available_copies": 2}
    mock_get_borrow_count.return_value = 2
    mock_insert_borrow.return_value = True
    mock_update_avail.return_value = True

    success, msg = lib.borrow_book_by_patron("123456", 1)
    assert success is True
    assert "successfully borrowed" in msg.lower()

def test_borrow_book_invalid_patron_id():
    success, msg = lib.borrow_book_by_patron("12a456", 1)
    assert not success
    assert "invalid patron id" in msg.lower()

@patch('library_service.get_book_by_id')
def test_borrow_book_not_found(mock_get_book):
    mock_get_book.return_value = None
    success, msg = lib.borrow_book_by_patron("123456", 1)
    assert not success
    assert "book not found" in msg.lower()

@patch('library_service.get_book_by_id')
def test_borrow_book_no_availability(mock_get_book):
    mock_get_book.return_value = {"title": "Book", "available_copies": 0}
    success, msg = lib.borrow_book_by_patron("123456", 1)
    assert not success
    assert "not available" in msg.lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrow_count')
def test_borrow_book_max_limit_reached(mock_get_borrow_count, mock_get_book):
    mock_get_book.return_value = {"title": "Book", "available_copies": 1}
    mock_get_borrow_count.return_value = 5
    success, msg = lib.borrow_book_by_patron("123456", 1)
    assert not success
    assert "maximum borrowing limit" in msg.lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrow_count')
@patch('library_service.insert_borrow_record')
def test_borrow_book_insert_fail(mock_insert_borrow, mock_get_borrow_count, mock_get_book):
    mock_get_book.return_value = {"title": "Book", "available_copies": 2}
    mock_get_borrow_count.return_value = 1
    mock_insert_borrow.return_value = False
    success, msg = lib.borrow_book_by_patron("123456", 1)
    assert not success
    assert "database error" in msg.lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrow_count')
@patch('library_service.insert_borrow_record')
@patch('library_service.update_book_availability')
def test_borrow_book_update_avail_fail(mock_update_avail, mock_insert_borrow, mock_get_borrow_count, mock_get_book):
    mock_get_book.return_value = {"title": "Book", "available_copies": 2}
    mock_get_borrow_count.return_value = 1
    mock_insert_borrow.return_value = True
    mock_update_avail.return_value = False
    success, msg = lib.borrow_book_by_patron("123456", 1)
    assert not success
    assert "database error" in msg.lower()


# ===== R4: return_book_by_patron =====

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
@patch('library_service.update_borrow_record_return_date')
@patch('library_service.update_book_availability')
def test_return_book_success(mock_update_avail, mock_update_return, mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book Title"}
    mock_get_borrowed_books.return_value = [{"book_id": 1, "due_date": datetime.now()}]
    mock_update_return.return_value = True
    mock_update_avail.return_value = True

    success, msg = lib.return_book_by_patron("123456", 1)
    assert success is True
    assert "successfully returned" in msg.lower()

def test_return_book_invalid_patron():
    success, msg = lib.return_book_by_patron("abc123", 1)
    assert not success
    assert "invalid patron id" in msg.lower()

@patch('library_service.get_book_by_id')
def test_return_book_not_found(mock_get_book):
    mock_get_book.return_value = None
    success, msg = lib.return_book_by_patron("123456", 1)
    assert not success
    assert "book not found" in msg.lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
def test_return_book_no_borrow_record(mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    mock_get_borrowed_books.return_value = []
    success, msg = lib.return_book_by_patron("123456", 1)
    assert not success
    assert "no borrowing record" in msg.lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
@patch('library_service.update_borrow_record_return_date')
def test_return_book_update_return_fail(mock_update_return, mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    mock_get_borrowed_books.return_value = [{"book_id": 1}]
    mock_update_return.return_value = False
    success, msg = lib.return_book_by_patron("123456", 1)
    assert not success
    assert "database error" in msg.lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
@patch('library_service.update_borrow_record_return_date')
@patch('library_service.update_book_availability')
def test_return_book_update_avail_fail(mock_update_avail, mock_update_return, mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    mock_get_borrowed_books.return_value = [{"book_id": 1}]
    mock_update_return.return_value = True
    mock_update_avail.return_value = False
    success, msg = lib.return_book_by_patron("123456", 1)
    assert not success
    assert "database error" in msg.lower()


# ===== R5: calculate_late_fee_for_book =====

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
def test_calculate_late_fee_not_overdue(mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    due_date = datetime.now() + timedelta(days=3)
    mock_get_borrowed_books.return_value = [{'book_id': 1, 'due_date': due_date}]
    result = lib.calculate_late_fee_for_book("123456", 1)
    assert result['fee_amount'] == 0.00
    assert result['days_overdue'] == 0
    assert result['status'] == 'Success'

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
def test_calculate_late_fee_within_7_days(mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    due_date = datetime.now() - timedelta(days=5)
    mock_get_borrowed_books.return_value = [{'book_id': 1, 'due_date': due_date}]
    result = lib.calculate_late_fee_for_book("123456", 1)
    assert result['days_overdue'] == 5
    assert result['fee_amount'] == 2.5
    assert 'overdue' in result['status'].lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
def test_calculate_late_fee_above_7_days(mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    due_date = datetime.now() - timedelta(days=10)
    mock_get_borrowed_books.return_value = [{'book_id': 1, 'due_date': due_date}]
    result = lib.calculate_late_fee_for_book("123456", 1)
    # 7*0.5 + 3*1 = 3.5 + 3 = 6.5
    assert result['fee_amount'] == 6.5
    assert result['days_overdue'] == 10

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
def test_calculate_late_fee_max_fee(mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    due_date = datetime.now() - timedelta(days=40)
    mock_get_borrowed_books.return_value = [{'book_id': 1, 'due_date': due_date}]
    result = lib.calculate_late_fee_for_book("123456", 1)
    assert result['fee_amount'] == 15.00  # max capped

def test_calculate_late_fee_invalid_patron():
    result = lib.calculate_late_fee_for_book("12a456", 1)
    assert result['fee_amount'] == 0
    assert 'invalid patron id' in result['status'].lower()

@patch('library_service.get_book_by_id')
def test_calculate_late_fee_book_not_found(mock_get_book):
    mock_get_book.return_value = None
    result = lib.calculate_late_fee_for_book("123456", 1)
    assert result['fee_amount'] == 0
    assert 'book not found' in result['status'].lower()

@patch('library_service.get_book_by_id')
@patch('library_service.get_patron_borrowed_books')
def test_calculate_late_fee_no_active_record(mock_get_borrowed_books, mock_get_book):
    mock_get_book.return_value = {"title": "Book"}
    mock_get_borrowed_books.return_value = []
    result = lib.calculate_late_fee_for_book("123456", 1)
    assert result['fee_amount'] == 0
    assert 'no active borrowing record' in result['status'].lower()


# ===== R7: get_patron_status_report =====
# Important: get_db_connection is imported inside the function, so patch the *database* module
@patch('library_service.get_patron_borrowed_books')
@patch('database.get_db_connection')
def test_get_patron_status_report_valid(mock_get_db_conn, mock_get_borrowed_books):
    mock_get_borrowed_books.return_value = [
        {'book_id': 1, 'due_date': datetime.now() - timedelta(days=5), 'is_overdue': True},
        {'book_id': 2, 'due_date': datetime.now() + timedelta(days=3), 'is_overdue': False}
    ]

    mock_cursor = MagicMock()
    mock_cursor.fetchall.return_value = [
        {'book_id': 1, 'title': "Book One", 'author': "Author A", 'borrow_date': "2024-01-01", 'due_date': "2024-01-15", 'return_date': None},
        {'book_id': 2, 'title': "Book Two", 'author': "Author B", 'borrow_date': "2024-01-05", 'due_date': "2024-01-19", 'return_date': None}
    ]
    mock_conn = MagicMock()
    mock_conn.execute.return_value = mock_cursor
    mock_get_db_conn.return_value = mock_conn

    result = lib.get_patron_status_report("123456")
    assert 'currently_borrowed_books' in result
    assert 'total_late_fees' in result
    assert result['total_borrowed'] == 2
    assert result['total_late_fees'] > 0

def test_get_patron_status_report_invalid_patron():
    result = lib.get_patron_status_report("abc123")
    assert 'error' in result
    assert result['currently_borrowed_books'] == []
    assert result['total_borrowed'] == 0
    assert result['total_late_fees'] == 0.0
    assert result['borrowing_history'] == []


if __name__ == '__main__':
    pytest.main()
